CREATE TABLE analysis_df AS 
SELECT 
    d.cid, 
    i.mkt_id, 
    i.eid_tenure, 
    i.mkt_ave_tenure, 
    i.mkt_ave_cidtocid, 
    i.sweath_fct, 
    COALESCE(q.asset_qty, 0) AS asset_qty, 
    d.ab_error, 
    d.ov_error, 
    d.total_error, 
    CASE 
        WHEN COALESCE(q.asset_qty, 0) = 0 THEN 0 -- Avoid division by zero, set accuracy to 0% if no assets
        ELSE (1 - COALESCE(d.total_error, 0) / COALESCE(q.asset_qty, 0)) * 100 
    END AS acc_fct
FROM 
    assay_dv_cid AS d
LEFT JOIN 
    var_analysis AS i
ON 
    d.cid = i.cid
LEFT JOIN 
    (
        SELECT 
            cid, 
            COUNT(asset_id) AS asset_qty
        FROM 
            inv_output_uverse
        GROUP BY 
            cid
    ) AS q
ON 
    d.cid = q.cid;
